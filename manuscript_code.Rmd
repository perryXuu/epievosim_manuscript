---
title: "Manuscript_code"
output: html_document
date: "2024-03-21"
---

```{r}
library("poweRlaw")
library("ggplot2")
library("igraph")
library("ape")
library("ggtree")
library("adephylo")
```

## Create the distribution from the haslemere dataset

Read the network and store into a matrix & a vector
```{r}
has_df = read.csv("/Users/px54/Documents/TB_software/Haslemere_dt/Kissler_DataS1.csv", header = F, col.names = c("time", "user1", "user2", "dist"))
num_hosts = range(c(has_df$user1, has_df$user2))[2]

has_df_filtered = has_df[has_df$dist<10,]
contact_mtx_filtered = matrix(rep(0, num_hosts * num_hosts), nrow = num_hosts, ncol = num_hosts)

#contact_mtx = matrix(rep(0, num_hosts * num_hosts), nrow = num_hosts, ncol = num_hosts)
for (i in 1:nrow(has_df))
{
  host1 = has_df_filtered[i,]$user1
  host2 = has_df_filtered[i,]$user2
#  host1 = has_df[i,]$user1
#  host2 = has_df[i,]$user2
  contact_mtx_filtered[host1, host2] = 1
  contact_mtx_filtered[host2, host1] = 1
}
degree_host = c()
for (i in 1:num_hosts)
{
  degree_host = c(degree_host, sum(contact_mtx_filtered[i,]))
}

```


## Fit the data into power law distribution
Visualize the data
```{r}
data=degree_host[degree_host>0]
degree_counts = c()
numhosts_minus1 = num_hosts - 1
for (i in 0:numhosts_minus1)
{
  degree_counts = c(degree_counts, length(which(i==degree_host)))
}
degree_density <- degree_counts/num_hosts
data.dist = data.frame(k=1:length(degree_density[degree_density>0]), p_k=degree_density[degree_density>0])
p1 <- ggplot(data.dist) + geom_point(aes(x=k, y=p_k)) + theme_bw() + theme(panel.grid=element_blank(), axis.title.x = element_text(size = 16),
  axis.text.x = element_text(size = 14),
  axis.text.y = element_text(size = 14),
  axis.title.y = element_text(size = 16),
  legend.text=element_text(size=12),
  legend.title=element_text(size=13)) + labs(x="Contact Degrees",y="Frequency") #+ ggtitle("Degree distribution of the filtered Haslemere dataset")

suppressWarnings(ggsave("/Users/px54/Documents/TB_software/manuscript_test/degdist_haslemere.pdf", plot = p1, width = 6, height = 5, dpi = 300))
print(p1)
```

Fit power-law and log-normal distribution
```{r}
m_pl <- displ$new(data)
#m_ln = dislnorm$new(data)
est_pl <- estimate_xmin(m_pl)
#est_ln <- estimate_xmin(m_ln)
est_pl
#est_ln

## Bootstrap
bs_pl <- bootstrap(m_pl, xmins = seq(2, 20, 2))
#bs_ln <- bootstrap(m_ln, xmins = seq(2, 20, 2))

bs_pl
#bs_ln

```

Scan the whole region
```{r}
data.s <- unique(data)

d_est <- data.frame(K_min=sort(data.s)[1:(length(data.s)-2)], gamma=rep(0,length(data.s)-2), D=rep(0,length(data.s)-2))

## PL
for (i in d_est$K_min){
  d_est[which(d_est$K_min == i),2] <- estimate_xmin(m_pl, xmins = i)$pars
  d_est[which(d_est$K_min == i),3] <- estimate_xmin(m_pl, xmins = i)$gof
}

K.min_D.min <- d_est[which.min(d_est$D), 1]

p2 <- ggplot(data=d_est, aes(x=K_min, y=D)) + geom_line() + theme_bw() + 
  geom_vline(xintercept=K.min_D.min, colour="red") + annotate("text", x=K.min_D.min, y=max(d_est$D)/3*2, label=K.min_D.min) + theme(panel.grid=element_blank(), axis.title.x = element_text(size = 16),
  axis.text.x = element_text(size = 14),
  axis.text.y = element_text(size = 14),
  axis.title.y = element_text(size = 16),
  legend.text=element_text(size=12),
  legend.title=element_text(size=13)) + labs(x="x_min",y="D") #+ ggtitle("K-S statistics between the fitted theoretical CDF and the data CDF")

suppressWarnings(ggsave("/Users/px54/Documents/TB_software/manuscript_test/D_xmin.pdf", plot = p2, width = 6, height = 5, dpi = 300))

p3 <- ggplot(data=d_est, aes(x=K_min, y=gamma)) + geom_line() + theme_bw() + 
  geom_vline(xintercept=K.min_D.min, colour="red") + annotate("text", x=K.min_D.min, y=max(d_est$gamma)/3*2, label=K.min_D.min) + theme(panel.grid=element_blank(), axis.title.x = element_text(size = 16),
  axis.text.x = element_text(size = 14),
  axis.text.y = element_text(size = 14),
  axis.title.y = element_text(size = 16),
  legend.text=element_text(size=12),
  legend.title=element_text(size=13)) + labs(x="x_min",y=expression(alpha)) #+ ggtitle("Maximum Likelihood estimate of \u03B1") 

suppressWarnings(ggsave("/Users/px54/Documents/TB_software/manuscript_test/alpha_xmin.pdf", plot = p3, width = 6, height = 5, dpi = 300))
print(p3)


## LN

#lg_est <- data.frame(K_min=sort(data.s)[1:(length(data.s)-3)], mu=rep(0,length(data.s)-3), sigma=rep(0,length(data.s)-3), gof=rep(0,length(data.s)-3))
#for (i in lg_est$K_min){
#  lg_est[which(lg_est$K_min == i),2] <- estimate_xmin(m_ln, xmins = i)$pars[1]
#  lg_est[which(lg_est$K_min == i),3] <- estimate_xmin(m_ln, xmins = i)$pars[2]
#  lg_est[which(lg_est$K_min == i),4] <- estimate_xmin(m_ln, xmins = i)$gof
#}
#K.min_gof.min <- lg_est[which.min(lg_est$gof), 1]
#ggplot(data=lg_est, aes(x=K_min, y=gof)) + geom_line() + theme_bw() + 
#  geom_vline(xintercept=K.min_gof.min, colour="red") + annotate("text", x=K.min_gof.min, y=max(lg_est$gof)/3*2, #label=K.min_gof.min) + ggtitle("GOF vs. xmin for Log-Normal fitting")
#ggplot(data=lg_est, aes(x=K_min, y=mu)) + geom_line() + theme_bw() + 
#  geom_vline(xintercept=K.min_gof.min, colour="red") + annotate("text", x=K.min_gof.min, y=max(lg_est$mu)/3*2, #label=K.min_gof.min) + ggtitle("Mu vs. xmin for Log-Normal fitting")
#ggplot(data=lg_est, aes(x=K_min, y=sigma)) + geom_line() + theme_bw() + 
#  geom_vline(xintercept=K.min_gof.min, colour="red") + annotate("text", x=K.min_gof.min, y=max(lg_est$sigma)/3*2, #label=K.min_gof.min) + ggtitle("Sigma vs. xmin for Log-Normal fitting")


```

Plot the fitted-law on CDF curve
```{r}
m_pl$setXmin(est_pl)
plot.data <- plot(m_pl, draw = F)
fit.data <- lines(m_pl, draw = F)

p4 <- ggplot(plot.data) + geom_point(aes(x=log(x), y=log(y))) + labs(x="log(k)", y="log(CDF)") + theme_bw() + 
  geom_line(data=fit.data, aes(x=log(x), y=log(y)), colour="red") + theme(panel.grid=element_blank(), axis.title.x = element_text(size = 16),
  axis.text.x = element_text(size = 14),
  axis.text.y = element_text(size = 14),
  axis.title.y = element_text(size = 16),
  legend.text=element_text(size=12),
  legend.title=element_text(size=13)) # + ggtitle("Fitted Power-law distribution")

suppressWarnings(ggsave("/Users/px54/Documents/TB_software/manuscript_test/fitted_cdf.pdf", plot = p4, width = 6, height = 5, dpi = 300))
print(p4)

bs_pl <- bootstrap_p(m_pl, no_of_sims=1000, threads=8, seed = 123)
#threads=core number of processor that used by function
#parallel::detectCores() determines how many cores in your computer

pdf(file="/Users/px54/Documents/TB_software/manuscript_test/bootstrap.pdf")
plot(bs_pl)
dev.off()

df_bs_pl <- bs_pl$bootstraps

gamma_D.min <- d_est[which.min(d_est$D), 2]

#ggplot(data=df_bs_pl, aes(x=xmin, y=pars)) + labs(x="X_min", y="\u03B1") + theme_bw() + 
#  geom_point(shape=21, colour="black", fill="red", size=0.5, stroke=2, 
#             position = position_jitter(), alpha=0.6) +
#  geom_vline(xintercept=K.min_D.min, colour="blue") +
#  geom_hline(yintercept=gamma_D.min, colour="blue") +
#  annotate("text", x=K.min_D.min, y=min(df_bs_pl$pars), label=K.min_D.min, col="blue") +
#  annotate("text", x=min(df_bs_pl$xmin), y=gamma_D.min, label=round(gamma_D.min, digits=2), col="blue")+ theme(panel.grid=element_blank(), axis.title.x = element_text(size = 16),
#  axis.text.x = element_text(size = 14),
#  axis.text.y = element_text(size = 14),
#  axis.title.y = element_text(size = 16),
#  legend.text=element_text(size=12),
#  legend.title=element_text(size=13)) + ggtitle("Bootstrap Results")

D.min <- d_est[which.min(d_est$D), 3]

#ggplot(data=df_bs_pl, aes(gof)) + geom_histogram() + labs(x="D", y="frequency") + geom_vline(xintercept=D.min, colour="red") + theme_bw()

bs_pl$p
```

## Fitting the real distribution
```{R}
#generate kmin & kmax pairs
pairs <- as.data.frame(t(combn(sort(data.s), 2)))
pairs$D <- rep(0, length(pairs$V1))
pairs$gamma <- rep(0, length(pairs$V1))

#scan D for all kmin-kmax pairs
for (i in 1:length(pairs$D)){
  m_pl$setXmin(pairs[i,1])
  pairs[i,3]<- estimate_xmin(m_pl, xmin = pairs[i,1], xmax = pairs[i,2], distance = "ks")$gof
  pairs[i,4]<- estimate_xmin(m_pl, xmin = pairs[i,1], xmax = pairs[i,2], distance = "ks")$pars
}

```



```{r}
bs_pl_sat_cut <- bootstrap_p(m_pl, xmins = pairs[which.min(pairs$D), 1], xmax = pairs[which.min(pairs$D), 2], no_of_sims = 1000, threads = 8)

pairs[which.min(pairs$D), 1] #k_{sat}
pairs[which.min(pairs$D), 2]
pairs[which.min(pairs$D), 3]
pairs[which.min(pairs$D), 4]
bs_pl_sat_cut$p
pairs[which.min(pairs$D), 1] -> k_sat
pairs[which.min(pairs$D), 2] -> k_cut
pairs[which.min(pairs$D), 4] -> gamma
```

```{r}
#powerlaw
m_pl = displ$new(data)
est_pl <- estimate_xmin(m_pl, xmins = k_sat, xmax = k_cut, distance = "ks")
m_pl$setXmin(est_pl)

#lognormal
#m_ln = dislnorm$new(data)
#est_ln <- estimate_xmin(m_ln)
#m_ln$setXmin(est_ln)

#exponential
#m_exp = disexp$new(data)
#est_exp <- estimate_xmin(m_exp)
#m_exp$setXmin(est_exp)

#poisson
#m_poi = dispois$new(data)
#est_poi <- estimate_xmin(m_poi)
#m_poi$setXmin(est_poi)
#plot(m_pl)
#lines(m_pl, col="red")
#lines(m_ln, col="green")
#lines(m_poi, col="blue")
#lines(m_exp, col="magenta")
```











Fit real data by log normal distribution
```{r}
#generate kmin & kmax pairs
pairs <- as.data.frame(t(combn(sort(data.s), 2)))
pairs$gof <- rep(0, length(pairs$V1))
pairs$mu <- rep(0, length(pairs$V1))
pairs$sigma <- rep(0, length(pairs$V1))


#scan params for all kmin-kmax pairs
for (i in 1:length(pairs$gof)){
  m_ln$setXmin(pairs[i,1])
  pairs[i,3]<- estimate_xmin(m_ln, xmin = pairs[i,1], xmax = pairs[i,2], distance = "ks")$gof
  pairs[i,4]<- estimate_xmin(m_ln, xmin = pairs[i,1], xmax = pairs[i,2], distance = "ks")$pars[1] 
  pairs[i,5]<- estimate_xmin(m_ln, xmin = pairs[i,1], xmax = pairs[i,2], distance = "ks")$pars[2]
}
bs_pl_sat_cut <- bootstrap_p(m_ln, xmins = pairs[which.min(pairs$gof), 1], xmax = pairs[which.min(pairs$gof), 2], no_of_sims = 1000, threads = 8)

pairs[which.min(pairs$gof), 1] #k_{sat}
pairs[which.min(pairs$gof), 2]
pairs[which.min(pairs$gof), 3]
pairs[which.min(pairs$gof), 4]
pairs[which.min(pairs$gof), 5]
bs_pl_sat_cut$p
pairs[which.min(pairs$gof), 1] -> k_sat
pairs[which.min(pairs$gof), 2] -> k_cut
pairs[which.min(pairs$gof), 4] -> mu
pairs[which.min(pairs$gof), 5] -> sigma
```

Create a graph
```{r}
set.seed(1)
newNumhosts=12907
newNumedges=round(newNumhosts*(sum(degree_host)/num_hosts))
#newNumedges = round(newNumhosts * ((newNumhosts-1) * (sum(degree_host)/num_hosts / (num_hosts - 1))))
#gamma=6.21
g <- sample_fitness_pl(newNumhosts, newNumedges, exponent.out= gamma, exponent.in = -1, loops = FALSE, multiple = FALSE, finite.size.correction = TRUE)
#data1 <- degree(g)
#data1 <- data1[data1>0]
len_degree = length(degree_distribution(g)) - 1
data1.dist <- data.frame(k=0:len_degree,p_k=degree_distribution(g))
data1.dist <- data1.dist[data1.dist$p_k>0,]
p5 <- ggplot(data1.dist) + geom_point(aes(x=k, y=p_k)) + theme_bw() + theme(panel.grid=element_blank(), axis.title.x = element_text(size = 16),
  axis.text.x = element_text(size = 14),
  axis.text.y = element_text(size = 14),
  axis.title.y = element_text(size = 16),
  legend.text=element_text(size=12),
  legend.title=element_text(size=13)) # + ggtitle("Fitted Power-law distribution")

print(p5)

#suppressWarnings(ggsave("/Users/px54/Documents/TB_software/manuscript_test/rescaled_dis.pdf", plot = p4, width = 6, height = 5, dpi = 300))


adj_lst = as_adj_list(g, "total")
## write adjacency list to the working directory
outdir = "/Users/px54/Documents/TB_software/manuscript_test/gisaid_23Oct_24Mar11/"
file.remove(file.path(outdir, "contact_network_generated"))
edge_num_test = 0
for (i in 1:length(adj_lst))
{
  line = as.vector(adj_lst[[i]])
  edge_num_test = edge_num_test + length(line)
  write(paste(c(i-1, line-1), collapse = " "), file=file.path(outdir, "contact_network_generated"), append=TRUE)
}
```

Read network
```{r}
#ntwk_dir="/Users/px54/Documents/TB_software/manuscript_test/gisaid_23Oct_24Mar11/ori_size_contact_network.adjlist"
ntwk_dir="/Users/px54/Documents/TB_software/manuscript_test/gisaid_23Oct_24Mar11/run/contact_network.adjlist"
con=file(ntwk_dir,open="r")
alllines=readLines(con)
#lines = alllines[1:length(alllines)]
lines = alllines[4:length(alllines)]
num_hosts_new=length(lines)
num_hostsminus1 = num_hosts_new - 1
contact_num = data.frame(nodeid=0:num_hostsminus1, contacts=rep(0, num_hosts_new))
for (i in 1:num_hosts_new){
    vct_line = as.integer(unlist(strsplit(lines[i], split=" ")))
    if (length(vct_line)>=2){
      for (j in 2:length(vct_line))
      {
        contact_num[contact_num$nodeid==vct_line[1],]$contacts = contact_num[contact_num$nodeid==vct_line[1],]$contacts + 1
        contact_num[contact_num$nodeid==vct_line[j],]$contacts = contact_num[contact_num$nodeid==vct_line[j],]$contacts + 1
      }
    }
    
}
close(con)

#ks.test(degree_host, contact_num$contacts)
```

Plotting degree distribution
```{R}
seed_host_match = read.csv("/Users/px54/Documents/TB_software/manuscript_test/gisaid_23Oct_24Mar11/run/seed_host_match.csv", header=T)
seed_host_match$degree = rep(0, 16)
seed_host_match$color = rep(" ", 16)
colorcode = c('#440154', '#3b528b', '#21918c', '#5ec962', '#fde725')
for (i in 1:nrow(seed_host_match))
{
  seed_host_match[i,]$degree = contact_num[which(contact_num$nodeid==seed_host_match[i,]$host_id),]$contacts
  if (seed_host_match[i,]$seed %in% c(1, 2, 6))
  {
    seed_host_match[i,]$color = colorcode[1]
  } else if (seed_host_match[i,]$seed %in% c(3,4,5))
  {
    seed_host_match[i,]$color = colorcode[3]
  } else
  {
    seed_host_match[i,]$color = colorcode[5]
  }
  #seed_host_match[i,]$color = colorcode[seed_host_match[i,]$seed + 1]
}

p6 <- ggplot(contact_num, aes(x=contacts)) + geom_histogram(binwidth=1, fill='#D21F3C', color="black") + theme_bw() + 
  theme(panel.grid=element_blank(), axis.title.x = element_text(size = 16),
  axis.text.x = element_text(size = 14),
  axis.text.y = element_text(size = 14),
  axis.title.y = element_text(size = 16),
  legend.text=element_text(size=12),
  legend.title=element_text(size=13),
  panel.background = element_rect(fill = "white")) +
 labs(x="Contact degree",y="Counts of Individuals")

for (i in 1:nrow(seed_host_match))
{
  #if (i %in% c(0))
  #{
    p6 <- p6 + geom_vline(xintercept=seed_host_match[i,]$degree, color=seed_host_match[i,]$color, size=1) #+
   # annotate("text", x=seed_host_match[i,]$degree+0.5, y=4700, label=paste(c("Seed", seed_host_match[i,]$seed), collapse=" "), angle=90, color=seed_host_match[i,]$color, size=14/.pt)
  #}
  #else
  #{
  #  p4 <- p4 + geom_vline(xintercept=seed_host_match[i,]$degree, color=seed_host_match[i,]$color, size=2, linetype="longdash") +
  #  annotate("text", x=seed_host_match[i,]$degree-0.6, y=4700, label=paste(c("Seed", seed_host_match[i,]$seed), collapse=" "), angle=90, color=seed_host_match[i,]$color, size=14/.pt)
  #}
}

p6 <- p6 + scale_x_continuous(expand = c(0, 0)) +  # Remove x-axis padding
    scale_y_continuous(expand = c(0, 0))

suppressWarnings(ggsave("/Users/px54/Documents/TB_software/manuscript_test/redist_match.pdf", plot = p6, width = 6, height = 5, dpi = 300))
```












Output the density to NetworkX
```{R}
writeLines(paste(density_restored, collapse = " "), "/Users/px54/Documents/TB_software/manuscript_test/gisaid_23Oct_24Mar11/rescaled_density.txt")
```

If using `has_df`, it takes forever to run that networkX function........
If using `has_df_filtered`, it's always not graphical........


# Alternative way (try to fit a BA netwok)
## Try to calculate m assuming a BA network model
```{R}
m = sum(degree_host)/num_hosts
m ## m=3.73
```

## Read the networkX generated graph generated by m=4 and do KS test
```{r}
#ntwk_dir="/Users/px54/Documents/TB_software/manuscript_test/gisaid_23Oct_24Mar11/ori_size_contact_network.adjlist"
ntwk_dir="/Users/px54/Documents/TB_software/V2_code/test/test_drugresist/contact_network.adjlist"
con=file(ntwk_dir,open="r")
alllines=readLines(con)
lines = alllines[4:length(alllines)]
num_hosts=length(lines)
num_hostsminus1 = num_hosts - 1
contact_num = data.frame(nodeid=0:num_hostsminus1, contacts=rep(0, num_hosts))
for (i in 1:num_hosts){
    vct_line = as.integer(unlist(strsplit(lines[i], split=" ")))
    if (length(vct_line)>=2){
      for (j in 2:length(vct_line))
      {
        contact_num[contact_num$nodeid==vct_line[1],]$contacts = contact_num[contact_num$nodeid==vct_line[1],]$contacts + 1
        contact_num[contact_num$nodeid==vct_line[j],]$contacts = contact_num[contact_num$nodeid==vct_line[j],]$contacts + 1
      }
    }
    
}
close(con)

#ks.test(degree_host, contact_num$contacts)
```

Deal with the seeds' nexus file
```{r}
tree_nx = "/Users/px54/Documents/TB_software/manuscript_test/gisaid_23Oct_24Mar11/seeds.tree.fasta.timetree.nex"
outgroup = "hCoV-19/Wuhan/WIV04/2019|EPI_ISL_402124|2019-12-30"
tree = read.nexus(tree_nx)
tree_height = max(distRoot(tree))
tree$edge.length = tree$edge.length / tree_height * 1371 
as.Date("2023-10-01") - as.Date("2019-12-30")
# Time difference of 1371 days
tree_noog = drop.tip(tree, outgroup)

nm_df = read.table("/Users/px54/Documents/TB_software/manuscript_test/gisaid_23Oct_24Mar11/sampled_seeds.name.txt")
new_names = c()
for (id in tree_noog$tip.label)
{
  new_names = c(new_names, nm_df[which(nm_df$V1==id),2])
}
#new_names
tree_noog$tip.label = new_names
tree_noog

write.tree(tree_noog, file=file.path("/Users/px54/Documents/TB_software/manuscript_test/gisaid_23Oct_24Mar11/run/seeds.nwk"))
```


```{r}
path_main = "/Users/px54/Documents/TB_software/manuscript_test/gisaid_23Oct_24Mar11/run/"
sim_size = 10
seed_size = 5
popsize = 10000

strain_default <- data.frame(
  JN.1 = 3,
  #JN.1.4 = 1,
  BA.2.86.1 = 3,
  #JN.1.1 = 1,
  EG.5.1.1 = 10
)

strain_names = c("JN.1", "JN.1.4", "BA.2.86.1", "JN.1.1", "EG.5.1.1")
colorcode = c('#440154', '#3b528b', '#21918c', '#5ec962', '#fde725')

all_data <- read.csv(paste0(path_main, "1/strain_trajectory.csv.gz"), header = F, sep = ",")
strain_data <- data.frame(
  JN.1 = all_data$V1 + all_data$V2 + all_data$V6,
  BA.2.86.1 = all_data$V3 + all_data$V4 + all_data$V5,
  EG.5.1.1 = all_data$V7 + all_data$V8 + all_data$V9 + all_data$V10 + all_data$V11 + all_data$V12 + all_data$V13 +
    all_data$V14 + all_data$V15 + all_data$V16
)
# colnames(strain_data) <- c("seed0", "seed1", "seed2", "seed3", "seed4")

strain_data <- rbind(strain_default, strain_data)
for (i in 1:nrow(strain_data))
{
  strain_data[i,] = strain_data[i,] / sum(strain_data[i,])
}

length_gen = nrow(strain_data)
strain_data$rep = rep(1, length_gen)
strain_data$generation = 1:length_gen
p10 <- ggplot(strain_data) + 
    scale_color_manual(name='States',
                     breaks=strain_names,
                     values=c(JN.1=colorcode[1],BA.2.86.1=colorcode[3],EG.5.1.1=colorcode[5])) +
  geom_line(data = strain_data, aes(x = generation, y=JN.1, color='JN.1', alpha = 0.35)) +
  #geom_line(data = strain_data, aes(x = generation, y=JN.1.4, color='JN.1.4', alpha = 0.35)) +
  geom_line(data = strain_data, aes(x = generation, y=BA.2.86.1, color='BA.2.86.1', alpha = 0.35)) +
  #geom_line(data = strain_data, aes(x = generation, y=JN.1.1, color='JN.1.1', alpha = 0.35)) +
  geom_line(data = strain_data, aes(x = generation, y=EG.5.1.1, color='EG.5.1.1', alpha = 0.35))

outbreaks = 1
for (sim in 2:sim_size)
{
  #strain_data_now <- read.csv(paste0(path_main, sim, "/strain_trajectory.csv.gz"), header = F, sep = ",")
  strain_data_now <- read.csv(paste0(path_main, sim, "/strain_trajectory.csv.gz"), header = F, sep = ",")
strain_data_now <- data.frame(
  JN.1 = strain_data_now$V1 + strain_data_now$V2 + strain_data_now$V6,
  #JN.1.4 = strain_data_now$V2,
  BA.2.86.1 = strain_data_now$V3 + strain_data_now$V4 + strain_data_now$V5,
  #JN.1.1 = strain_data_now$V6,
  EG.5.1.1 = strain_data_now$V7 + strain_data_now$V8 + strain_data_now$V9 + strain_data_now$V10 + strain_data_now$V11 + strain_data_now$V12 + strain_data_now$V13 +
    strain_data_now$V14 + strain_data_now$V15 + strain_data_now$V16
)
  strain_data_now <- rbind(strain_default, strain_data_now)
  for (i in 1:nrow(strain_data_now))
  {
    strain_data_now[i,] = strain_data_now[i,] / sum(strain_data_now[i,])
  }
  length_gen = nrow(strain_data_now)
  strain_data_now$rep = rep(sim, nrow(strain_data_now))
  strain_data_now$generation = 1:length_gen

  outbreaks = outbreaks + 1
  p10 <- p10 + geom_line(data = strain_data_now, aes(x = generation, y=JN.1, color='JN.1', alpha = 0.35)) +
  #geom_line(data = strain_data_now, aes(x = generation, y=JN.1.4, color='JN.1.4', alpha = 0.35)) +
  geom_line(data = strain_data_now, aes(x = generation, y=BA.2.86.1, color='BA.2.86.1', alpha = 0.35)) +
  #geom_line(data = strain_data_now, aes(x = generation, y=JN.1.1, color='JN.1.1', alpha = 0.35)) +
  geom_line(data = strain_data_now, aes(x = generation, y=EG.5.1.1, color='EG.5.1.1', alpha = 0.35))
  strain_data <- rbind(strain_data, strain_data_now)
}

avg_s0 = c()
avg_s1 = c()
avg_s2 = c()
avg_s3 = c()
avg_s4 = c()

for (i in 1:length_gen)
{
  avg_s0 = c(avg_s0, sum(strain_data[strain_data$generation==i,]$JN.1) / outbreaks)
  #avg_s1 = c(avg_s1, sum(strain_data[strain_data$generation==i,]$JN.1.4) / outbreaks)
  avg_s2 = c(avg_s2, sum(strain_data[strain_data$generation==i,]$BA.2.86.1) / outbreaks)
  #avg_s3 = c(avg_s3, sum(strain_data[strain_data$generation==i,]$JN.1.1) / outbreaks)
  avg_s4 = c(avg_s4, sum(strain_data[strain_data$generation==i,]$EG.5.1.1) / outbreaks)
}

p10 <- p10 + geom_line(aes(x=1:length_gen, y=avg_s0, color='JN.1'), size=2) + 
  #geom_line(aes(x=1:length_gen, y=avg_s1, color='JN.1.4'), size=2) + 
  geom_line(aes(x=1:length_gen, y=avg_s2, color="BA.2.86.1"), size=2) + 
  #geom_line(aes(x=1:length_gen, y=avg_s3, color='JN.1.1'), size=2) + 
  geom_line(aes(x=1:length_gen, y=avg_s4, color='EG.5.1.1'), size=2) +
  theme_bw() + theme(panel.grid=element_blank(), axis.title.x = element_text(size = 16),
  axis.text.x = element_text(size = 14),
  axis.text.y = element_text(size = 14),
  axis.title.y = element_text(size = 16),
  legend.text=element_text(size=12),
  legend.title=element_text(size=13), 
  legend.position="none")  + labs(x="Ticks",y="Size of the progeny") + guides(alpha="none") +
  xlim(0,180)# +
    #scale_x_continuous(expand = c(0, 0)) +  # Remove x-axis padding
   # scale_y_continuous(expand = c(0, 0))

p10 



#suppressWarnings(print(p1))
#suppressWarnings(ggsave("/Users/px54/Documents/TB_software/manuscript_test/strain_er.pdf", plot = p10, width = 6, height = 5, dpi = 300))

```




```{R}
seed_host_match = read.csv("/Users/px54/Documents/TB_software/manuscript_test/gisaid_23Oct_24Mar11/run/seed_host_match.csv", header=T)
seed_host_match$degree = rep(0, 16)
seed_host_match$color = rep(" ", 16)
colorcode = c('#440154', '#3b528b', '#21918c', '#5ec962', '#fde725')
for (i in 1:nrow(seed_host_match))
{
  seed_host_match[i,]$degree = contact_num[which(contact_num$nodeid==seed_host_match[i,]$host_id),]$contacts
  if (seed_host_match[i,]$seed %in% c(1, 2, 6))
  {
    seed_host_match[i,]$color = colorcode[1]
  } else if (seed_host_match[i,]$seed %in% c(3,4,5))
  {
    seed_host_match[i,]$color = colorcode[3]
  }  else
  {
    seed_host_match[i,]$color = colorcode[5]
  }
  #seed_host_match[i,]$color = colorcode[seed_host_match[i,]$seed + 1]
}

p6 <- ggplot(contact_num, aes(x=contacts)) + geom_histogram(binwidth=1, fill='#D21F3C') + theme_bw() + 
  theme(panel.grid=element_blank(), axis.title.x = element_text(size = 16),
  axis.text.x = element_text(size = 14),
  axis.text.y = element_text(size = 14),
  axis.title.y = element_text(size = 16),
  legend.text=element_text(size=12),
  legend.title=element_text(size=13),
  panel.background = element_rect(fill = "white")) +
 labs(x="Contact degrees",y="Individuals")

seed_host_match$degree_adjusted = c(10, 12, 19, 13, 10.5, 11, 9, 13.5, 14, 15, 17, 23, 14.5, 21, 13.5, 9.5)
for (i in 1:nrow(seed_host_match))
{
  #if (i %in% c(0))
  #{
    p6 <- p6 + geom_vline(xintercept=seed_host_match[i,]$degree_adjusted + rnorm(n=1, mean=0.5, sd=0.01), color=seed_host_match[i,]$color, size=0.5) #+
   # annotate("text", x=seed_host_match[i,]$degree+0.5, y=4700, label=paste(c("Seed", seed_host_match[i,]$seed), collapse=" "), angle=90, color=seed_host_match[i,]$color, size=14/.pt)
  #}
  #else
  #{
  #  p4 <- p4 + geom_vline(xintercept=seed_host_match[i,]$degree, color=seed_host_match[i,]$color, size=2, linetype="longdash") +
  #  annotate("text", x=seed_host_match[i,]$degree-0.6, y=4700, label=paste(c("Seed", seed_host_match[i,]$seed), collapse=" "), angle=90, color=seed_host_match[i,]$color, size=14/.pt)
  #}
}

p6 <- p6 + scale_x_continuous(expand = c(0, 0)) +  # Remove x-axis padding
    scale_y_continuous(expand = c(0, 0))

suppressWarnings(ggsave("/Users/px54/Documents/TB_software/manuscript_test/redist_match.pdf", plot = p6, width = 5, height = 3.5, dpi = 300))
```


Try to draw sampling trajectory
```{R}
sim = 8
path_main = "/Users/px54/Documents/TB_software/manuscript_test/gisaid_23Oct_24Mar11/run/"
sample_tb = read.table(file.path(path_main, sim, "sample.csv.gz"), header = F, sep = " ")
sampled_size = data.frame(days = 1:365, JN.1 = rep(0, 365), BA.2.86.1 = rep(0, 365), EG.5.1.1 = rep(0, 365))
mtch_id = c(1, 1, 2, 2, 2, 1, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3)
#for (i in 1:nrow(sample_tb))
#{
#  sampled_size[sample_tb[i,1], mtch_id[sample_tb[i,3]] + 1] = sampled_size[sample_tb[i,1], mtch_id[sample_tb[i,3]] + 1] + 1
#}
p01 <- ggplot(sample_tb[which(sample_tb$V3 %in% c(0, 1, 5)),]) + geom_histogram(aes(x = V1), alpha=0.5, fill="#440154", color="white", binwidth=20) + theme_bw() + theme(panel.grid=element_blank(), axis.title.x = element_blank(),
                     axis.text.x = element_text(size = 14, angle = 90),
  axis.text.y = element_text(size = 14),
  axis.title.y = element_text(size = 16),
  legend.text=element_text(size=12),
  legend.title=element_text(size=13), 
  legend.position="none")  + labs(x="Days",y="# of samples") +
  scale_x_continuous(breaks=c(62/2, 62 + (122-62)/2, 122 + (184-122)/2, 184 + (246-184)/2, 246 + (304-246)/2, 304+(365-304)/2), labels = c("2023-Oct", "2023-Nov", "2023-Dec", "2024-Jan", "2024-Feb", "2024-Mar")) +ylim(0, 300)

p02 <- ggplot(sample_tb[which(sample_tb$V3 %in% c(2, 3, 4)),]) + geom_histogram(aes(x = V1), alpha=0.5, fill="#21918c", color="white", binwidth=20) + theme_bw() + theme(panel.grid=element_blank(), axis.title.x = element_blank(),
                     axis.text.x = element_text(size = 14, angle = 90),
  axis.text.y = element_text(size = 14),
  axis.title.y = element_text(size = 16),
  legend.text=element_text(size=12),
  legend.title=element_text(size=13), 
  legend.position="none")  + labs(x="Days",y="# of samples") +
  scale_x_continuous(breaks=c(62/2, 62 + (122-62)/2, 122 + (184-122)/2, 184 + (246-184)/2, 246 + (304-246)/2, 304+(365-304)/2), labels = c("2023-Oct", "2023-Nov", "2023-Dec", "2024-Jan", "2024-Feb", "2024-Mar")) +ylim(0, 300)

p03 <- ggplot(sample_tb[which(sample_tb$V3 %in% 6:15),]) + geom_histogram(aes(x = V1), alpha=0.5, fill="#fde725", color="white", binwidth=20) + theme_bw() + theme(panel.grid=element_blank(), axis.title.x = element_blank(),
                     axis.text.x = element_text(size = 14, angle = 90),
  axis.text.y = element_text(size = 14),
  axis.title.y = element_text(size = 16),
  legend.text=element_text(size=12),
  legend.title=element_text(size=13), 
  legend.position="none")  + labs(x="Days",y="# of samples") +
  scale_x_continuous(breaks=c(62/2, 62 + (122-62)/2, 122 + (184-122)/2, 184 + (246-184)/2, 246 + (304-246)/2, 304+(365-304)/2), labels = c("2023-Oct", "2023-Nov", "2023-Dec", "2024-Jan", "2024-Feb", "2024-Mar")) +ylim(0, 300)

#p <- ggplot(sample_tb[which(sample_tb$V3 %in% 6:15),]) + geom_histogram(aes(x = V1), alpha=0.5, fill="#fde725", color="white")  +
#  geom_histogram(data = sample_tb[which(sample_tb$V3 %in% c(2, 3, 4)),], aes(x = V1), alpha=0.5, fill="#21918c", color="white")  +
#  geom_histogram(data = sample_tb[which(sample_tb$V3 %in% c(0, 1, 5)),], aes(x = V1), alpha=0.5, fill="#440154", color="white")


p01
p02
p03

suppressWarnings(ggsave("/Users/px54/Documents/TB_software/manuscript_test/sim_data_1.pdf", plot = p01, width = 4, height = 3.5, dpi = 300))
suppressWarnings(ggsave("/Users/px54/Documents/TB_software/manuscript_test/sim_data_2.pdf", plot = p02, width = 4, height = 3.5, dpi = 300))
suppressWarnings(ggsave("/Users/px54/Documents/TB_software/manuscript_test/sim_data_3.pdf", plot = p03, width = 4, height = 3.5, dpi = 300))

## sim 2 & 4 seem good
## 6, 8, shows how this tread is changed, so might also good
```



The GISAID data
```{R}
strain_names_all = c("JN.1", "JN.1.4", "BA.2.86.1", "JN.1.1", "EG.5.1.1")
strain_names = c("JN.1", "BA.2.86.1", "EG.5.1.1")
colorcode = c("#440154", "#21918c", "#fde725")

color_scale = c("JN.1"="#440154", "BA.2.86.1"= "#21918c", "EG.5.1.1"="#fde725")
diff_df = data.frame(days=1:180, JN.1 = rep(0, 180), BA.2.86.1 = rep(0, 180), EG.5.1.1 = rep(0, 180))

cdays_1 = c()
cdays_2 = c()
cdays_3 = c()

for (i in 1:5)
{
    print(i)
    seqnames_f=file.path("/Users/px54/Documents/TB_software/manuscript_test/gisaid_23Oct_24Mar31", paste(c(i, strain_names_all[i], "seqnames.txt"), collapse="_"))
    con=file(seqnames_f,open="r")
    seqnames=readLines(con)
    if (i %in% c(1,2,4))
    {
        id = 1
    } else if (i==3)
    {
        id = 2
    } else
    {
        id = 3
    }
    for (seq in seqnames)
    {
        seqinfo = strsplit(seq, split="\\|")
        date = seqinfo[[1]][length(seqinfo[[1]])]
        date_diff = as.numeric(as.numeric(as.Date(date) - as.Date("2023-10-01"), unit="days"), units="days")
        diff_df[date_diff, id + 1] = diff_df[date_diff, id + 1] + 1
        if (id==1)
        {
          cdays_1 = c(cdays_1, date_diff)
        } else if (id==2)
        {
          cdays_2 = c(cdays_2, date_diff)
        } else
        {
          cdays_3 = c(cdays_3, date_diff)
        }
    }
}

cdays_df1 = data.frame(days=cdays_1)
cdays_df2 = data.frame(days=cdays_2)
cdays_df3 = data.frame(days=cdays_3)

p04 <- ggplot(cdays_df1) + 
  geom_histogram(aes(x = days), alpha=0.5, fill="#440154", color="white", binwidth=10) + 
  theme_bw() + theme(panel.grid=element_blank(), axis.title.x = element_blank(),
                     axis.text.x = element_text(size = 14, angle = 90),
                     axis.text.y = element_text(size = 14),
                     axis.title.y = element_text(size = 16),
                     legend.text=element_text(size=12),
                     legend.title=element_text(size=13), 
                     legend.position="none")  + labs(y="# of samples") +ylim(0, 300) +coord_cartesian(xlim=c(0,180)) +
  scale_x_continuous(breaks=c(62/2/2, 62/2 + (122-62)/2/2, 122/2 + (184-122)/2/2, 184/2 + (246-184)/2/2, 246/2 + (304-246)/2/2, 304/2+(365-304)/2/2), 
                    labels = c("2023-Oct", "2023-Nov", "2023-Dec", "2024-Jan", "2024-Feb", "2024-Mar"))


p04

p05 <- ggplot(cdays_df2) + 
  geom_histogram(aes(x = days), alpha=0.5, fill="#21918c", color="white", binwidth=10) + 
  theme_bw() + theme(panel.grid=element_blank(), axis.title.x = element_blank(),
                     axis.text.x = element_text(size = 14, angle = 90),
                     axis.text.y = element_text(size = 14),
                     axis.title.y = element_text(size = 16),
                     legend.text=element_text(size=12),
                     legend.title=element_text(size=13), 
                     legend.position="none")  + labs(y="# of samples") +ylim(0, 300) +coord_cartesian(xlim=c(0,180)) +
  scale_x_continuous(breaks=c(62/2/2, 62/2 + (122-62)/2/2, 122/2 + (184-122)/2/2, 184/2 + (246-184)/2/2, 246/2 + (304-246)/2/2, 304/2+(365-304)/2/2), 
                    labels = c("2023-Oct", "2023-Nov", "2023-Dec", "2024-Jan", "2024-Feb", "2024-Mar"))


p06 <- ggplot(cdays_df3) + 
  geom_histogram(aes(x = days), alpha=0.5, fill="#fde725", color="white", binwidth=10) + 
  theme_bw() + theme(panel.grid=element_blank(), axis.title.x = element_blank(),
                     axis.text.x = element_text(size = 14, angle = 90),
                     axis.text.y = element_text(size = 14),
                     axis.title.y = element_text(size = 16),
                     legend.text=element_text(size=12),
                     legend.title=element_text(size=13), 
                     legend.position="none")  + labs(y="# of samples") +ylim(0, 300) +coord_cartesian(xlim=c(0,180)) +
  scale_x_continuous(breaks=c(62/2/2, 62/2 + (122-62)/2/2, 122/2 + (184-122)/2/2, 184/2 + (246-184)/2/2, 246/2 + (304-246)/2/2, 304/2+(365-304)/2/2), 
                    labels = c("2023-Oct", "2023-Nov", "2023-Dec", "2024-Jan", "2024-Feb", "2024-Mar"))


p05
p06

suppressWarnings(ggsave("/Users/px54/Documents/TB_software/manuscript_test/real_data_1.pdf", plot = p04, width = 4, height = 3.5, dpi = 300))
suppressWarnings(ggsave("/Users/px54/Documents/TB_software/manuscript_test/real_data_2.pdf", plot = p05, width = 4, height = 3.5, dpi = 300))
suppressWarnings(ggsave("/Users/px54/Documents/TB_software/manuscript_test/real_data_3.pdf", plot = p06, width = 4, height = 3.5, dpi = 300))
```
Draw SEIR curve
## Example 1
Read the data
```{R}
path_main = "/Users/px54/Documents/TB_software/manuscript_test/gisaid_23Oct_24Mar11/run/"
sim_size = 10
seed_size = 16
popsize = newNumhosts

seir_default <- data.frame(
  Susceptible = popsize - seed_size,
  Exposed = 0,
  Infected = seed_size,
  Recovered = 0
)

seir_data <- read.csv(paste0(path_main, "1/SEIR_trajectory.csv.gz"), header = F, sep = ",")
colnames(seir_data) <- c("Susceptible", "Exposed", "Infected", "Recovered")

seir_data <- rbind(seir_default, seir_data)

length_gen = nrow(seir_data)
seir_data$rep = rep(1, length_gen)
seir_data$generation = 1:length_gen
p1 <- ggplot(seir_data)  + 
    scale_color_manual(name='States',
                     breaks=c('susceptible', 'exposed', 'infected', 'recovered'),
                     values=c('susceptible'='blue','exposed'='yellow', 'infected'='red', 'recovered'='green'),
                     labels = c('susceptible'='Susceptible','exposed'='Exposed', 'infected'='Infected', 'recovered'='Recovered')) +
  geom_line(data = seir_data, aes(x = generation, y=Exposed, color='exposed', alpha = 0.2)) +
  geom_line(data = seir_data, aes(x = generation, y=Susceptible, color='susceptible', alpha = 0.2)) +
  geom_line(data = seir_data, aes(x = generation, y=Infected, color='infected', alpha = 0.2)) +
  geom_line(data = seir_data, aes(x = generation, y=Recovered, color='recovered', alpha = 0.2))

outbreaks = 1
for (sim in 2:sim_size)
{
  seir_data_now <- read.csv(paste0(path_main, sim, "/SEIR_trajectory.csv.gz"), header = F, sep = ",")
  colnames(seir_data_now) <- c("Susceptible", "Exposed", "Infected", "Recovered")
  seir_data_now <- rbind(seir_default, seir_data_now)
  length_gen = nrow(seir_data_now)
  seir_data_now$rep = rep(sim, nrow(seir_data_now))
  seir_data_now$generation = 1:length_gen
  if (seir_data_now[100,]$Exposed + seir_data_now[100,]$Infected > 0)
  {
    outbreaks = outbreaks + 1
    p1 <- p1 + geom_line(data = seir_data_now, aes(x = generation, y=Exposed, color='exposed', alpha = 0.2)) +
      geom_line(data = seir_data_now, aes(x = generation, y=Susceptible, color='susceptible', alpha = 0.2)) +
      geom_line(data = seir_data_now, aes(x = generation, y=Infected, color='infected', alpha = 0.2)) +
      geom_line(data = seir_data_now, aes(x = generation, y=Recovered, color='recovered', alpha = 0.2))
    seir_data <- rbind(seir_data, seir_data_now)
  }
}

avg_s = c()
avg_e = c()
avg_i = c()
avg_r = c()

for (i in 1:length_gen)
{
  avg_s = c(avg_s, sum(seir_data[seir_data$generation==i,]$Susceptible) / outbreaks)
  avg_e = c(avg_e, sum(seir_data[seir_data$generation==i,]$Exposed) / outbreaks)
  avg_i = c(avg_i, sum(seir_data[seir_data$generation==i,]$Infected) / outbreaks)
  avg_r = c(avg_r, sum(seir_data[seir_data$generation==i,]$Recovered) / outbreaks)
}

p1 <- p1 + geom_line(aes(x=1:length_gen, y=avg_s, color='susceptible')) + 
  geom_line(aes(x=1:length_gen, y=avg_i, color='infected')) + geom_line(aes(x=1:length_gen, y=avg_r, color="recovered")) + 
  geom_line(aes(x=1:length_gen, y=avg_e, color='exposed')) +
  theme_bw() + theme(panel.grid=element_blank(), axis.title.x = element_blank(),
                     axis.text.x = element_text(size = 14, angle = 90),
  axis.text.y = element_text(size = 14),
  axis.title.y = element_text(size = 16),
  legend.text=element_text(size=12),
  legend.title=element_text(size=13)) +
  scale_x_continuous(breaks=c(62/2, 62 + (122-62)/2, 122 + (184-122)/2, 184 + (246-184)/2, 246 + (304-246)/2, 304+(365-304)/2), labels = c("2023-Oct", "2023-Nov", "2023-Dec", "2024-Jan", "2024-Feb", "2024-Mar"))  + labs(y="# of Inidividuals") + guides(alpha="none")

suppressWarnings(print(p1))
suppressWarnings(ggsave("/Users/px54/Documents/TB_software/manuscript_test/seir_sim.pdf", plot = p1, width = 5, height = 3.5, dpi = 300))

```































==============
Tried before
=============




Generate the density sequence for the new big network
```{R}
Node_new = 15000
degree_counts = c()
numhosts_minus1 = num_hosts - 1
for (i in 0:numhosts_minus1)
{
  degree_counts = c(degree_counts, length(which(i==degree_host)))
}
## degree_counts: How many nodes are having each degree

#degree_density <- degree_counts/(sum(degree_counts))
degree_density <- degree_counts/num_hosts
## degree_density: Percentage of nodes having each degree

#normalized_degree_host <- degree_host/(sum(degree_counts))

## degree_host: How many degrees does each node has
normalized_degree_host <- degree_host/num_hosts
## normalized_degree_host: degree_host normalized by the maximum possible degree (num_host - 1)
rescaled_degree_host <- normalized_degree_host * Node_new
## rescaled_degree_host: project the density to the number of degrees each node has in a bigger network

density_rescaled = density(rescaled_degree_host, from=0, to=Node_new-1)
## The KDE-smoothed density from rescaled_degree_host

set.seed(989)
density_restored = floor(sample(density_rescaled$x, Node_new, rep=T, p=density_rescaled$y))
## Sample from the density distribution the degree in the big network

```






